import mongoose, { Document, Schema } from 'mongoose';

export type Severity = 'critical' | 'high' | 'medium' | 'low' | 'info';

export interface IVulnerability extends Document {
  scanId: mongoose.Types.ObjectId;
  repositoryId: mongoose.Types.ObjectId;
  userId: mongoose.Types.ObjectId;
  teamId?: mongoose.Types.ObjectId;
  ruleId: string;
  title: string;
  description: string;
  severity: Severity;
  owaspCategory: string;
  owaspId: string;
  filePath: string;
  lineStart: number;
  lineEnd: number;
  codeSnippet: string;
  aiConfirmed: boolean;
  aiExplanation?: string;
  aiPatchSuggestion?: string;
  aiImpactSummary?: string;
  patchApplied: boolean;
  prUrl?: string;
  falsePositive: boolean;
  createdAt: Date;
}

const vulnerabilitySchema = new Schema<IVulnerability>(
  {
    scanId: { type: Schema.Types.ObjectId, ref: 'Scan', required: true, index: true },
    repositoryId: { type: Schema.Types.ObjectId, ref: 'Repository', required: true, index: true },
    userId: { type: Schema.Types.ObjectId, ref: 'User', required: true, index: true },
    teamId: { type: Schema.Types.ObjectId, ref: 'Team', index: true },
    ruleId: { type: String, required: true },
    title: { type: String, required: true },
    description: { type: String, required: true },
    severity: {
      type: String,
      enum: ['critical', 'high', 'medium', 'low', 'info'],
      required: true,
      index: true,
    },
    owaspCategory: { type: String, required: true },
    owaspId: { type: String, required: true },
    filePath: { type: String, required: true },
    lineStart: { type: Number, required: true },
    lineEnd: { type: Number, required: true },
    codeSnippet: { type: String, required: true, maxlength: 2000 },
    aiConfirmed: { type: Boolean, default: false },
    aiExplanation: { type: String, maxlength: 4000 },
    aiPatchSuggestion: { type: String, maxlength: 4000 },
    aiImpactSummary: { type: String, maxlength: 2000 },
    patchApplied: { type: Boolean, default: false },
    prUrl: { type: String },
    falsePositive: { type: Boolean, default: false },
  },
  { timestamps: true }
);

export const Vulnerability = mongoose.model<IVulnerability>('Vulnerability', vulnerabilitySchema);
